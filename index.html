<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏£‡∏£.‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Sarabun', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-[#003366] text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="nav-logo" src="https://via.placeholder.com/50?text=Logo" alt="School Logo" class="w-12 h-12 rounded-full border-2 border-white object-cover hidden">
                <div>
                    <h1 class="font-bold text-lg tracking-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                    <p class="text-xs text-blue-200">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ</p>
                </div>
            </div>
            <div class="flex space-x-2 sm:space-x-4 text-sm">
                <button onclick="showPage('page-register')" class="px-3 py-1 rounded hover:bg-blue-800">‡πÇ‡∏´‡∏ß‡∏ï</button>
                <button onclick="showPage('page-realtime')" class="px-3 py-1 rounded hover:bg-blue-800">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="showPage('page-admin')" class="bg-amber-500 text-black px-3 py-1 rounded shadow-inner font-bold">Admin</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        
        <section id="page-register" class="page max-w-md mx-auto animate-fade-in">
            <div class="bg-white p-8 rounded-3xl shadow-2xl border border-gray-100">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
                    <p class="text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="space-y-6">
                    <input type="text" id="input-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ñ‡∏£‡∏π" 
                        class="w-full border-2 border-gray-100 p-4 rounded-2xl text-center text-2xl focus:border-blue-500 outline-none transition-all shadow-sm">
                    <button onclick="verifyUser()" 
                        class="w-full bg-[#003366] text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-900 transition-all shadow-lg">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </section>

        <section id="page-vote" class="page hidden space-y-8 animate-fade-in">
            <div class="bg-white p-6 rounded-2xl shadow-sm flex flex-col md:flex-row justify-between items-center border-l-8 border-[#003366]">
                <div>
                    <h2 id="user-info" class="text-2xl font-bold text-gray-900">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2>
                    <p class="text-gray-600">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå</p>
                </div>
                <button onclick="location.reload()" class="mt-4 md:mt-0 text-red-500 font-medium hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏≠‡∏≠‡∏Å</button>
            </div>
            <div id="candidate-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </section>

        <section id="page-realtime" class="page hidden">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-black text-[#003366] mb-2">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏î</h2>
                <p class="text-gray-500 tracking-widest text-sm">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>

            <div class="max-w-3xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-4 border-blue-500 text-center">
                    <p class="text-gray-500 text-sm">‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="stat-total" class="text-3xl font-black text-gray-800">0</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-4 border-green-500 text-center">
                    <p class="text-gray-500 text-sm">‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß</p>
                    <p id="stat-voted" class="text-3xl font-black text-green-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-4 border-amber-500 text-center">
                    <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
                    <p id="stat-pending" class="text-3xl font-black text-red-500">0</p>
                </div>
            </div>

            <div class="max-w-3xl mx-auto mb-10 px-4">
                <div class="flex justify-between mb-2 text-sm font-bold text-gray-600">
                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                    <span id="stat-percent-text">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="overall-progress-bar" class="bg-blue-600 h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>

            <div id="realtime-results" class="grid gap-4 max-w-3xl mx-auto p-6 bg-white rounded-3xl shadow-lg"></div>
        </section>

        <section id="page-admin" class="page hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold mb-4 text-blue-700">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl mb-4">
                        <span id="status-text" class="font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</span>
                        <button id="toggle-btn" onclick="toggleVoting()" class="bg-gray-800 text-white px-6 py-2 rounded-full hover:bg-black transition">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</button>
                    </div>
                    <button onclick="exportResultImage()" class="w-full bg-blue-50 text-blue-700 py-3 rounded-xl font-bold hover:bg-blue-100 transition">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                    <div class="mt-4 p-4 bg-red-50 rounded-xl border border-red-100">
                        <p class="text-red-600 text-xs mb-2">* ‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå</p>
                        <button onclick="resetSystem()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-100">
                            ‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold mb-4 text-blue-700">üè´ ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <input type="text" id="school-logo-url" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏à‡∏≤‡∏Å Google Drive" class="border w-full p-3 rounded-xl mb-4">
                    <button onclick="saveLogoUrl()" class="bg-[#003366] text-white px-6 py-2 rounded-xl hover:bg-blue-900 w-full transition font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ</button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
                    <h3 class="text-lg font-bold mb-4 text-blue-700">üìä ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Excel)</h3>
                    <input type="file" id="excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 mb-4">
                    <button onclick="uploadExcel()" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 w-full transition font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    <div class="mt-4">
                        <button onclick="exportVoterStatus()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-100 flex items-center justify-center gap-2">
                            üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Excel)
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
                    <h3 class="text-lg font-bold mb-6 text-blue-700">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£/‡∏û‡∏£‡∏£‡∏Ñ (‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input type="number" id="c-no" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå" class="border p-3 rounded-xl">
                        <input type="text" id="c-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ/‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" class="border p-3 rounded-xl">
                        <input type="text" id="c-detail" placeholder="‡∏™‡πÇ‡∏•‡πÅ‡∏Å‡∏ô" class="border p-3 rounded-xl">
                        <input type="text" id="c-img-url" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ Google Drive" class="border p-3 rounded-xl text-sm">
                        <button onclick="addCandidate()" id="btn-save-candidate" class="bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    <p class="text-xs text-red-500 mt-2">* ‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡πà‡∏≤‡∏ô"</p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2 mt-8">
                    <h3 class="text-lg font-bold mb-4 text-blue-700 flex items-center">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-center">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                    <th class="py-3 px-6">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                                    <th class="py-3 px-6">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ</th>
                                    <th class="py-3 px-6">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                    <th class="py-3 px-6 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="admin-candidate-list" class="text-gray-600 text-sm font-light"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
       import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, increment, onSnapshot, query, orderBy, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyBX3jxBteIkRNHsqpkLh0rRHLlcgtDV1oI",
            authDomain: "student-council-election-31443.firebaseapp.com",
            databaseURL: "https://student-council-election-31443-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "student-council-election-31443",
            storageBucket: "student-council-election-31443.firebasestorage.app",
            messagingSenderId: "84426008374",
            appId: "1:84426008374:web:fb2c47fea7a31f6b0b3597",
            measurementId: "G-PTZCSX7W0B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let isVotingOpen = false;

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏ß‡∏ï ---
        onSnapshot(doc(db, "settings", "schoolLogo"), (d) => {
            if(d.exists()){
                const img = document.getElementById('nav-logo');
                img.src = d.data().url;
                img.classList.remove('hidden');
            }
        });

        onSnapshot(doc(db, "settings", "voting"), (d) => {
            if(d.exists()){
                isVotingOpen = d.data().isOpen;
                document.getElementById('status-text').innerText = isVotingOpen ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: üîí ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï";
            }
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ---
        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ---
        window.verifyUser = async () => {
            const sid = document.getElementById('input-id').value.trim();
            if(!sid) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß");
            if(!isVotingOpen) return alert("‚ùå ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");

            const uSnap = await getDoc(doc(db, "users", sid));
            if(uSnap.exists()){
                const data = uSnap.data();
                if(data.hasVoted) return alert("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
                currentUser = { id: sid, ...data };
                document.getElementById('user-info').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ: ${data.‡∏ä‡∏∑‡πà‡∏≠} ${data.‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•}`;
                loadVoteGrid();
                showPage('page-vote');
            } else {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ");
            }
        };

        // --- ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏£‡∏Ñ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏ß‡∏ï (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏£‡∏≠‡∏ö) ---
// --- ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏£‡∏Ñ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏ß‡∏ï (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏î‡∏µ) ---
function loadVoteGrid() {
    const q = query(collection(db, "candidates"), orderBy("number", "asc"));
    onSnapshot(q, (snap) => {
        const grid = document.getElementById('candidate-grid');
        grid.innerHTML = "";
        snap.forEach(d => {
            const c = d.data();
            
            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á Card ---
            grid.innerHTML += `
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 flex flex-col h-full transform transition hover:scale-[1.02]">
                    
                    <div class="w-full h-64 bg-gray-50 flex items-center justify-center p-2">
                        <img src="${c.img || 'https://via.placeholder.com/400x300'}" 
                             class="max-w-full max-h-full object-contain rounded-2xl"
                             alt="‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏Ñ ${c.name}">
                    </div>

                    <div class="p-6 text-center flex flex-col flex-grow bg-white">
                        <div>
                            <span class="bg-blue-100 text-[#003366] px-4 py-1 rounded-full text-sm font-bold uppercase tracking-wider">
                                ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.number}
                            </span>
                            <h3 class="text-2xl font-black mt-3 text-gray-800">${c.name}</h3>
                            <p class="text-gray-500 text-sm mt-2 line-clamp-2 h-10">${c.detail || ''}</p>
                        </div>
                        
                        <div class="mt-auto pt-4">
                            <button onclick="confirmVote('${d.id}', '${c.name}')" 
                                    class="w-full bg-[#22c55e] text-white py-4 rounded-2xl font-bold text-lg hover:bg-[#16a34a] transition-all shadow-lg shadow-green-100 active:scale-95">
                                ‡πÇ‡∏´‡∏ß‡∏ï
                            </button>
                        </div>
                    </div>
                </div>`;
        });
    });
}
        window.confirmVote = async (cid, name) => {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡πâ "${name}" ?`)) return;
            await updateDoc(doc(db, "candidates", cid), { votes: increment(1) });
            await updateDoc(doc(db, "users", currentUser.id), { hasVoted: true });
            alert("‚úÖ ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            location.reload();
        };

        // --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Admin Real-time ---
        const adminQ = query(collection(db, "candidates"), orderBy("number", "asc"));
        onSnapshot(adminQ, (snap) => {
            const list = document.getElementById('admin-candidate-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                list.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-6 text-center font-bold">${c.number}</td>
                        <td class="py-3 px-6 text-center"><img src="${c.img}" class="w-10 h-10 rounded mx-auto object-cover"></td>
                        <td class="py-3 px-6 font-bold">${c.name}</td>
                        <td class="py-3 px-6 text-gray-500">${c.detail || '-'}</td>
                        <td class="py-3 px-6 text-center">
                            <button onclick="editCandidate('${d.id}', ${c.number}, '${c.name}', '${c.detail || ''}', '${c.img}')" class="text-blue-600 mr-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteCandidate('${d.id}', '${c.name}')" class="text-red-600">üóëÔ∏è ‡∏•‡∏ö</button>
                        </td>
                    </tr>`;
            });
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏£‡∏Ñ ---
        window.addCandidate = async () => {
            const no = document.getElementById('c-no').value;
            const name = document.getElementById('c-name').value;
            const detail = document.getElementById('c-detail').value;
            const rawUrl = document.getElementById('c-img-url').value;
            if(!no || !name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            const docRef = doc(db, "candidates", "p_"+no);
            const snap = await getDoc(docRef);
            let votes = 0;
            if(snap.exists()) {
                votes = snap.data().votes;
                if(!confirm("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            }

            await setDoc(docRef, { number: parseInt(no), name, detail, img: formatGDriveLink(rawUrl), votes });
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            ['c-no','c-name','c-detail','c-img-url'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('btn-save-candidate').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        };

        window.editCandidate = (id, no, name, detail, img) => {
            document.getElementById('c-no').value = no;
            document.getElementById('c-name').value = name;
            document.getElementById('c-detail').value = detail;
            document.getElementById('c-img-url').value = img;
            document.getElementById('btn-save-candidate').innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.deleteCandidate = async (id, name) => {
            if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) await deleteDoc(doc(db, "candidates", id));
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° ---
        window.toggleVoting = async () => await setDoc(doc(db, "settings", "voting"), { isOpen: !isVotingOpen });
        
        window.saveLogoUrl = async () => {
            const url = formatGDriveLink(document.getElementById('school-logo-url').value);
            await setDoc(doc(db, "settings", "schoolLogo"), { url });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß");
        };

        function formatGDriveLink(url) {
            if (url.includes('drive.google.com')) {
                let fileId = url.includes('id=') ? url.split('id=')[1].split('&')[0] : url.split('/d/')[1].split('/')[0];
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            return url;
        }

        window.uploadExcel = async () => {
    const fileInput = document.getElementById('excel-file');
    const file = fileInput.files[0];
    
    if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Pop-up ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    const statusDiv = document.createElement('div');
    statusDiv.id = 'upload-loader';
    statusDiv.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
            <div class="bg-white p-8 rounded-2xl text-center shadow-2xl">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-lg font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                <p id="progress-count" class="text-sm text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
            </div>
        </div>
    `;
    document.body.appendChild(statusDiv);

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const sheetName = wb.SheetNames[0];
            const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);

            if (json.length === 0) throw new Error("‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

            let successCount = 0;
            const progText = document.getElementById('progress-count');

            for (let row of json) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Excel ‡πÄ‡∏õ‡πä‡∏∞‡πÜ)
                const studentId = String(row['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] || "").trim();
                
                if (studentId) {
                    await setDoc(doc(db, "users", studentId), {
                        ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: studentId,
                        ‡∏ä‡∏∑‡πà‡∏≠: row['‡∏ä‡∏∑‡πà‡∏≠'] || "",
                        ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: row['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || "",
                        ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: row['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || "",
                        ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: row['‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô'] || "",
                        hasVoted: false,
                        isRegistered: false
                    });
                    successCount++;
                    progText.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${successCount} ‡∏à‡∏≤‡∏Å ${json.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                }
            }

            alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${successCount} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠`);
        } catch (error) {
            console.error(error);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message + "\n‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Excel ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà");
        } finally {
            // ‡∏•‡∏ö Pop-up ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏Å
            document.getElementById('upload-loader').remove();
            fileInput.value = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå
        }
    };
    reader.readAsArrayBuffer(file);
};

        // --- ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Real-time ---
        onSnapshot(query(collection(db, "candidates"), orderBy("votes", "desc")), (snap) => {
            const res = document.getElementById('realtime-results');
            res.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                res.innerHTML += `
                    <div class="flex items-center p-4 bg-gray-50 rounded-xl">
                        <img src="${c.img}" class="w-12 h-12 rounded-full object-cover mr-4">
                        <div class="flex-1 font-bold">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.number} - ${c.name}</div>
                        <div class="text-2xl font-black text-blue-900">${c.votes}</div>
                    </div>`;
            });
        });

       window.exportResultImage = async () => {
    // 1. ‡πÅ‡∏™‡∏î‡∏á Loading
    const btn = document.querySelector('[onclick="exportResultImage()"]');
    const originalText = btn.innerText;
    btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...";
    btn.disabled = true;

    try {
        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const q = query(collection(db, "candidates"), orderBy("votes", "desc"));
        const querySnapshot = await getDocs(q); // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ import getDocs ‡πÅ‡∏•‡πâ‡∏ß
        const candidates = [];
        querySnapshot.forEach(doc => candidates.push(doc.data()));

        if (candidates.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏£‡∏Ñ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const padding = 60;
        canvas.width = 1000;
        canvas.height = 300 + (candidates.length * 100);

        // 4. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 5. ‡∏ß‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        ctx.fillStyle = "#003366"; // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°
        ctx.font = "bold 50px Sarabun, sans-serif";
        ctx.fillText("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á", padding, 100);
        
        ctx.font = "bold 30px Sarabun, sans-serif";
        ctx.fillStyle = "#333333";
        ctx.fillText("‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", padding, 150);

        // 6. ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á
        ctx.beginPath();
        ctx.moveTo(padding, 180);
        ctx.lineTo(canvas.width - padding, 180);
        ctx.strokeStyle = "#dddddd";
        ctx.stroke();

        // 7. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏£‡∏Ñ
        let y = 250;
        const maxVotes = Math.max(...candidates.map(p => p.votes), 1);

        candidates.forEach((c, index) => {
            // ‡∏•‡∏≥‡∏î‡∏±‡∏ö
            ctx.fillStyle = index === 0 ? "#f59e0b" : "#666666"; // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà 1
            ctx.font = "bold 35px Sarabun";
            ctx.fillText(`#${index + 1}`, padding, y);

            // ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ
            ctx.fillStyle = "#000000";
            ctx.font = "bold 32px Sarabun";
            ctx.fillText(`‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.number} - ${c.name}`, padding + 100, y);

            // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar Graph)
            const barMaxWidth = 450;
            const barWidth = (c.votes / maxVotes) * barMaxWidth;
            
            ctx.fillStyle = "#e5e7eb"; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô (‡∏û‡∏∑‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü)
            ctx.fillRect(550, y - 30, barMaxWidth, 35);
            
            ctx.fillStyle = "#003366"; // ‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            ctx.fillRect(550, y - 30, barWidth, 35);

            // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            ctx.fillStyle = "#003366";
            ctx.font = "bold 35px Sarabun";
            ctx.fillText(`${c.votes.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 550 + barMaxWidth + 20, y);

            y += 100;
        });

        // 8. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        const image = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = `‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô-${new Date().getTime()}.png`;
        link.href = image;
        link.click();
        
        alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

    } catch (err) {
        console.error("Error:", err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    } finally {
        // 9. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

// --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ---
window.showPage = (id) => {
    if (id === 'page-admin') {
        const password = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin:");
        if (password !== "1234") {
            alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            return; // ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        }
    }
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏ô‡πâ‡∏≤ admin
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
};

// --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Auto Update) ---
onSnapshot(collection(db, "users"), (snap) => {
    let total = snap.size; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô users
    let voted = 0;

    snap.forEach(doc => {
        if (doc.data().hasVoted === true) {
            voted++;
        }
    });

    let percent = total > 0 ? ((voted / total) * 100).toFixed(2) : 0;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    document.getElementById('stat-total').innerText = total.toLocaleString();
    document.getElementById('stat-voted').innerText = voted.toLocaleString();
    document.getElementById('stat-percent').innerText = percent + "%";
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Progress Bar ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß-‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
    document.getElementById('overall-progress-bar').style.width = percent + "%";
});

window.resetSystem = async () => {
    const confirm1 = confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
    if (!confirm1) return;

    const confirm2 = confirm("üö© ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?");
    if (!confirm2) return;

    // ‡πÅ‡∏™‡∏î‡∏á Loading
    const btn = document.querySelector('[onclick="resetSystem()"]');
    btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï...";
    btn.disabled = true;

    try {
        const batch = writeBatch(db);

        // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô candidates
        const candidatesSnap = await getDocs(collection(db, "candidates"));
        candidatesSnap.forEach((d) => {
            batch.update(doc(db, "candidates", d.id), { votes: 0 });
        });

        // 2. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô users
        const usersSnap = await getDocs(collection(db, "users"));
        usersSnap.forEach((d) => {
            batch.update(doc(db, "users", d.id), { hasVoted: false });
        });

        // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        await batch.commit();

        alert("‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ‡πÉ‡∏´‡∏°‡πà");
    } catch (error) {
        console.error(error);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    } finally {
        btn.innerText = "‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï";
        btn.disabled = false;
    }
};

window.exportVoterStatus = async () => {
    // 1. ‡πÅ‡∏™‡∏î‡∏á Loading
    const btn = document.querySelector('[onclick="exportVoterStatus()"]');
    const originalText = btn.innerText;
    btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
    btn.disabled = true;

    try {
        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firebase
        const querySnapshot = await getDocs(collection(db, "users"));
        const data = [];

        querySnapshot.forEach((doc) => {
            const user = doc.data();
            data.push({
                "‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß": user.‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß || "",
                "‡∏ä‡∏∑‡πà‡∏≠": user.‡∏ä‡∏∑‡πà‡∏≠ || "",
                "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": user.‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• || "",
                "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô": user.‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô|| "",
                "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô": user.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô || "",
                "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï": user.hasVoted ? "‚úÖ ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
                "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": user.votedAt ? new Date(user.votedAt).toLocaleString('th-TH') : "-"
            });
        });

        if (data.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
        data.sort((a, b) => a.‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß.localeCompare(b.‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß));

        // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Worksheet ‡πÅ‡∏•‡∏∞ Workbook
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï");

        // 5. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)
        const wscols = [
            {wch: 15}, {wch: 20}, {wch: 20}, {wch: 15}, {wch: 20}, {wch: 25}
        ];
        worksheet['!cols'] = wscols;

        // 6. ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        XLSX.writeFile(workbook, `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå_${new Date().toLocaleDateString('th-TH')}.xlsx`);

    } catch (error) {
        console.error(error);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

// --- ‡πÄ‡∏ù‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ö‡∏ö Real-time ---
onSnapshot(collection(db, "users"), (snap) => {
    let total = snap.size; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let voted = 0;

    snap.forEach(doc => {
        if (doc.data().hasVoted === true) {
            voted++;
        }
    });

    let pending = total - voted; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÇ‡∏´‡∏ß‡∏ï
    let percent = total > 0 ? ((voted / total) * 100).toFixed(1) : 0;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    document.getElementById('stat-total').innerText = total.toLocaleString();
    document.getElementById('stat-voted').innerText = voted.toLocaleString();
    document.getElementById('stat-pending').innerText = pending.toLocaleString();
    document.getElementById('stat-percent-text').innerText = percent + "%";
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ñ‡∏ö Progress Bar
    document.getElementById('overall-progress-bar').style.width = percent + "%";
});

    </script>
</body>
</html>